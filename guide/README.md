# YAML格式插件

在开发者文档中，我们将详细介绍如何使用YAML编写POC（Proof of Concept，利用证明）和指纹识别规则。

YAML是JSON的超集，具有更高的可读性和简洁性，可以方便地编写扫描规则。

编写POC和指纹识别规则有助于深入理解漏洞，提升安全能力，并提高在安全领域的知名度。

## POC编写的意义
编写POC（Proof of Concept，利用证明）具有重要的意义，主要体现在以下几个方面：

1. **漏洞验证**：通过编写针对特定漏洞的POC，可以快速地验证目标系统是否存在该漏洞，帮助安全工程师更有效地评估风险；
2. **提升安全技能**：编写POC需要深入理解漏洞原理并搭建相应的漏洞环境，有助于安全工程师提升自身的安全能力和技术水平；
3. **漏洞管理**：编写POC有助于组织实现更加标准化、自动化的漏洞管理流程，提高漏洞发现和修复的效率；
4. **安全研究**：通过编写和分析POC，安全工程师可以挖掘潜在的漏洞类型，为未来的安全研究奠定基础；
5. **提高在安全领域的知名度**：成功编写的POC可能被收录到各种漏洞扫描工具和框架中，为其他安全从业者提供便利，从而提高在安全领域的知名度；
6. **奖励机制**：提交POC到相关社区，例如CT stack社区，可以获得金币奖励，用于兑换相关礼品，如xray高级版、周边礼品等。

## 指纹识别的意义
指纹识别是信息安全领域中一项重要的技术，可以帮助安全工程师快速识别目标系统的环境、组件和配置信息。通过编写指纹插件，可以实现以下目标：

1. **快速识别目标环境**：利用指纹插件快速获取目标系统的详细信息，为进一步的漏洞探测和利用提供便利；
2. **提升扫描效率**：根据指纹识别结果，有针对性地进行漏洞扫描，提高扫描效率；
3. **定制化扫描策略**：针对不同的指纹识别结果，实现定制化的扫描策略，提高扫描准确性。

## 为什么使用xray的yaml格式编写POC/指纹？

使用xray的yaml格式编写POC和指纹识别规则具有以下优势：

1. **易于编写**：yaml格式简洁、可读，无需使用双引号包裹值，特殊字符无需转义，降低编写规则的难度；
2. **可读性**：内容更加可读，易于理解；
3. **注释支持**：可以使用注释来说明代码意图，提高代码可维护性。
4. **可扩展性**：xray的yaml格式可以轻松地支持新的漏洞和指纹识别规则，便于持续扩展和优化。

## 设计目标

设计目标:

1. 简洁而优雅
2. 能覆盖大部分常见扫描规则场景，包括不限于
    1. 主机指纹识别
    2. WEB 指纹识别
    3. 主机漏洞探测
    4. WEB 漏洞探测

我们希望：

1. 对规则本身提供一个很好的抽象，屏蔽掉编程语言的复杂度，只专注于规则本身。
2. 我们希望能给安全开发者更少学习成本以及更简单的编写规则，能统一目前各种规则的驳杂。



## 生命周期

为了帮助大家更好的理解 poc 中各部分的作用，此处先介绍一下一个 yaml poc 的执行过程。

在一个 yaml poc 从文件加载到 go 的某个结构后，会首先对表达式进行预编译和静态类型检查，这一过程主要作用于 yaml 中的 set 和 expression 部分，这两部分是 yaml poc 的关键，主要用到了 CEL 表达式。

在检查完成后，内存中的 poc 就处于等待调度的状态了。每当有**新的请求**来临时，会执行类似如下的伪代码:

```golang
for rule in rules:
    newReq = mutate_request_by_rule(req, rule)
    response = send(newReq)
    if not check_response(response, rule):
        break
```

简单来讲就是将请求根据 rule 中的规则对请求变形，然后获取变形后的响应，再检查响应是否匹配 `expression` 部分的表达式。如果匹配，就进行下一个 rule，如果不匹配则退出执行。
如果成功执行完了最后一个 rule，那么代表目标有漏洞，将 detail 中的信息附加到漏洞输出后就完成了单个 poc 的整个流程。

目前版本的实现对**新的请求**定义为: **新的目录**, 比如下面几个 url 依次进入检查队列时，执行情况如下：

```
http://exmaple.com/     会执行, 上下文为 / 
http://example.com/a    不会再次执行，因为上下文同样为 /
http://example.com/a/b  会执行，上下文为 /a/
http://example.com/a/c/ 不会执行, 超过深度限制 (depth)
```

其中 `depth` 是 phantasm 插件的一个配置项，用于指定检测深度，可以参考： [插件配置](/configration/plugins?id=dirscan)

## 转义说明

在编写expression表达式的时候，尤其要注意一个问题：yaml字符串的转义，与CEL表达式字符串里的转义。

yaml中，如果要编写一个字符串类型的值，可以使用引号进行包裹，如：

```yaml
name: "value"
```

但如果value中有反斜线，会在解析yaml的时候进行转义。那么如果expression表达式代码中也存在双引号或转义符，此时转义符就已经没有了，我们需要双重转义，这个时候编写的代码就非常不可读也不可维护。

所以，建议使用yaml中支持的[块样式（block style）](https://yaml.org/spec/1.2/spec.html#style/block/)来表示，如：

```
expression: |
  response.status == 200 && response.body.bcontains(b'\x01\x02\x03')
```

此时在YAML层面无需转义。


